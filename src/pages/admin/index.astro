---
import Layout from "@/layouts/Layout.astro";
import { capitalizeWords } from "@/lib/utils";

const cookieHeader = Astro.request?.headers.get("cookie") || "";
const origin = new URL(Astro.request?.url || "http://localhost:4321").origin;
const pendingUsersResponse = await fetch(`${origin}/api/users/pending`, {
  headers: { cookie: cookieHeader },
});

const data = await pendingUsersResponse.json();
const pendingUsers = data?.users || [];

const appointmentsResponse = await fetch(`${origin}/api/appointments`, {
  headers: { cookie: cookieHeader },
});

const appointmentsData = await appointmentsResponse.json();
const appointments = appointmentsData?.appointments || [];

const booksThisWeek = appointments.filter((appointment: any) => {
  const appointmentDate = new Date(appointment.appointmentDate);
  const today = new Date();
  const weekFromToday = new Date();
  weekFromToday.setDate(today.getDate() + 7);

  return appointmentDate >= today && appointmentDate <= weekFromToday;
}).length;

const activeDays = Array.from(
  new Set(
    appointments.map((appointment: any) => {
      const appointmentDate = new Date(appointment.appointmentDate);
      return appointmentDate.toDateString();
    }),
  ),
).length;

const availableHours = appointments.length;

const reservedAppointments = await fetch(
  `${origin}/api/appointments?type=reserved`,
  {
    headers: { cookie: cookieHeader },
  },
);

const reservedData = await reservedAppointments.json();
const reserved = reservedData?.appointments || [];

const today = new Date();
const booksToday =
  reserved?.filter((appointment: any) => {
    const appointmentDate = new Date(appointment.appointmentDate);
    return (
      appointmentDate.getDate() === today.getDate() &&
      appointmentDate.getMonth() === today.getMonth() &&
      appointmentDate.getFullYear() === today.getFullYear()
    );
  }).length || 0;
---

<Layout
  title="Panel de Administraci√≥n"
  description="Gesti√≥n de reservas y disponibilidad"
>
  <div class="admin-container">
    <header>
      <section class="header">
        <h1>PANEL DE ADMINISTRACI√ìN</h1>
        <p>Gesti√≥n de reservas y disponibilidad</p>
      </section>

      <section class="stats">
        <article class="stat-card">
          <div class="stat-number">{booksToday}</div>
          <div class="stat-label">Reservas Hoy</div>
        </article>
        <article class="stat-card">
          <div class="stat-number">{booksThisWeek}</div>
          <div class="stat-label">Esta Semana</div>
        </article>
        <article class="stat-card">
          <div class="stat-number">{activeDays}</div>
          <div class="stat-label">D√≠as Activos</div>
        </article>
        <article class="stat-card">
          <div class="stat-number">{availableHours}</div>
          <div class="stat-label">Horas Disponibles</div>
        </article>
      </section>
    </header>

    <main class="main-panels">
      <section class="panel panel-full">
        <h2 class="panel-title">A√±adir Cita Disponible</h2>
        <form>
          <div class="form-row">
            <div class="form-group">
              <label for="day">Fecha</label>
              <input type="date" id="day" required />
            </div>
            <div class="form-group">
              <label for="hour">Hora</label>
              <input type="time" id="hour" required />
            </div>
          </div>
          <button id="create-appointment" type="submit" class="btn btn-add"
            >+ A√±adir Cita Disponible</button
          >
        </form>

        <div class="dias-list">
          {
            appointments.map((appointment: any) => {
              const date = new Date(appointment.appointmentDate);
              const dayOfWeekFormatted = capitalizeWords(
                date.toLocaleString("es-ES", {
                  weekday: "short",
                  day: "2-digit",
                  month: "short",
                  hour: "2-digit",
                  minute: "2-digit",
                  hour12: false,
                }),
              );

              return (
                <div id={appointment.id} class="chip">
                  <span>{dayOfWeekFormatted}</span>
                  <span class="chip-remove">√ó</span>
                </div>
              );
            })
          }
        </div>
      </section>

      <section class="panel panel-full">
        <h2 class="panel-title">Reservas Actuales</h2>
        <div class="reservas-list">
          {
            reserved.map((appointment: any) => {
              const date = new Date(appointment.appointmentDate);
              const dayOfWeekFormatted = capitalizeWords(
                date.toLocaleDateString("es-ES", { weekday: "short" }) +
                  " " +
                  date.toLocaleDateString("es-ES", {
                    day: "2-digit",
                    month: "short",
                  }),
              );

              return (
                <div id={appointment.id} class="reserva-item">
                  <div class="reserva-header">
                    <span class="reserva-cliente">{appointment.userName}</span>
                    <span class="reserva-estado">Confirmada</span>
                  </div>
                  <div class="reserva-info">
                    <div class="reserva-fecha">
                      <span>üìÖ</span>
                      <span>{dayOfWeekFormatted}</span>
                    </div>
                    <div class="reserva-hora">
                      <span>üïê</span>
                      <span>
                        {date.toLocaleTimeString("es-ES", {
                          hour: "2-digit",
                          minute: "2-digit",
                          hour12: false,
                        })}
                      </span>
                    </div>
                    <div>
                      <span>üìû</span>
                      <span>{appointment.userPhone}</span>
                    </div>
                  </div>
                </div>
              );
            })
          }
        </div>
      </section>
      <section class="panel panel-full">
        <h2 class="panel-title">Confirmaci√≥n de Registros Pendientes</h2>
        <div class="reservas-list">
          {
            pendingUsers.map((user: any) => (
              <div id={user.id} class="reserva-item">
                <div class="reserva-header">
                  <span class="reserva-cliente">{user.fullName}</span>
                  <span
                    class="reserva-estado"
                    style="background: #4a3d29; color: #f0c674;"
                  >
                    Pendiente
                  </span>
                </div>
                <div class="reserva-info">
                  <div class="reserva-fecha">
                    <span>üìß</span>
                    <span>{user.email}</span>
                  </div>
                </div>
                <div class="btn-group" style="margin-top: 12px;">
                  <button
                    id="accept-pending-user"
                    class="btn btn-small btn-add"
                    style="width: auto;"
                  >
                    ‚úì Aprobar
                  </button>
                  <button
                    id="reject-pending-user"
                    class="btn btn-small"
                    style="width: auto; background: #4a2929;"
                  >
                    ‚úó Rechazar
                  </button>
                </div>
              </div>
            ))
          }
        </div>
      </section>
    </main>
  </div>
</Layout>

<script>
  import { toast } from "@/lib/toast";
  import { capitalizeWords } from "@/lib/utils";

  document
    .getElementById("create-appointment")
    ?.addEventListener("click", async (e) => {
      e.preventDefault();

      const date = (document.getElementById("day") as HTMLInputElement)?.value;
      const time = (document.getElementById("hour") as HTMLInputElement)?.value;

      const response = await fetch(`/api/appointments`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        credentials: "include",
        body: JSON.stringify({ date, time }),
      });

      const result = await response.json();

      if (result.success) {
        const date = new Date(result.appointment.appointmentDate);
        const dayOfWeekFormatted = capitalizeWords(
          date.toLocaleString("es-ES", {
            weekday: "short",
            day: "2-digit",
            month: "short",
            hour: "2-digit",
            minute: "2-digit",
            hour12: false,
          }),
        );

        const chip = document.createElement("div");
        chip.className = "chip";
        chip.innerHTML = `
        <span>${dayOfWeekFormatted}</span>
        <span class="chip-remove">√ó</span>
      `;

        document.querySelector(".dias-list")?.appendChild(chip);

        toast.success(result.message);
      } else {
        toast.error(result.error);
      }
    });

  document.querySelectorAll("#accept-pending-user").forEach((button) => {
    button.addEventListener("click", async () => {
      const appointmentItem = button.closest(".reserva-item");
      const userId = appointmentItem?.id;

      const response = await fetch(`/api/users/${userId}/approve`, {
        method: "POST",
        credentials: "include",
      });

      const result = await response.json();

      if (result.success) {
        appointmentItem?.remove();

        toast.success(result.message);
      } else {
        toast.error(result.error);
      }
    });
  });

  document.querySelectorAll("#reject-pending-user").forEach((button) => {
    button.addEventListener("click", async () => {
      const appointmentItem = button.closest(".reserva-item");
      const userId = appointmentItem?.id;

      const response = await fetch(`/api/users/${userId}/reject`, {
        method: "POST",
        credentials: "include",
      });

      const result = await response.json();

      if (result.success) {
        appointmentItem?.remove();

        toast.success(result.message);
      } else {
        toast.error(result.error);
      }
    });
  });

  document.querySelectorAll(".chip-remove").forEach((chipRemove) => {
    chipRemove.addEventListener("click", async () => {
      const chip = chipRemove.closest(".chip");
      const appointmentId = chip?.id;

      const response = await fetch(`/api/appointments/${appointmentId}`, {
        method: "DELETE",
        headers: {
          "Content-Type": "application/json",
        },
        credentials: "include",
      });

      const result = await response.json();

      if (result.success) {
        chip?.remove();
        toast.success(result.message);
      } else {
        toast.error(result.error);
      }
    });
  });
</script>

<style>
  .admin-container {
    max-width: 1200px;
    margin: 0 auto;
  }

  .header {
    text-align: center;
    margin-bottom: 48px;
  }

  .header h1 {
    color: #ffffff;
    font-size: 32px;
    font-weight: 300;
    letter-spacing: 2px;
    margin-bottom: 8px;
  }

  .header p {
    color: #9ca3af;
    font-size: 14px;
  }

  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
    gap: 24px;
    margin-bottom: 24px;
  }

  .panel {
    background: #232323;
    border-radius: 16px;
    padding: 32px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
  }

  .panel-full {
    grid-column: 1 / -1;
  }

  .panel-title {
    color: #ffffff;
    font-size: 20px;
    font-weight: 500;
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 1px solid #3a3a3a;
  }

  .form-group {
    margin-bottom: 20px;
  }

  label {
    display: block;
    color: #9ca3af;
    font-size: 14px;
    margin-bottom: 8px;
    font-weight: 400;
  }

  input[type="date"],
  input[type="time"],
  input[type="text"] {
    width: 100%;
    padding: 12px 16px;
    background: #1a1a1a;
    border: 1px solid #3a3a3a;
    border-radius: 8px;
    color: #ffffff;
    font-size: 15px;
    transition: all 0.3s ease;
    outline: none;
  }

  input[type="date"]:focus,
  input[type="time"]:focus,
  input[type="text"]:focus {
    border-color: #6b7280;
    background: #1f1f1f;
  }

  .btn {
    width: 100%;
    padding: 12px;
    background: #3a3a3a;
    color: #ffffff;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .btn:hover {
    background: #4a4a4a;
    transform: translateY(-1px);
  }

  .btn:active {
    transform: translateY(0);
  }

  .btn-add {
    background: #2d4a3e;
  }

  .btn-add:hover {
    background: #3a5c4f;
  }

  .reservas-list {
    max-height: 500px;
    overflow-y: auto;
    padding-right: 8px;
  }

  .reservas-list::-webkit-scrollbar {
    width: 6px;
  }

  .reservas-list::-webkit-scrollbar-track {
    background: #1a1a1a;
    border-radius: 3px;
  }

  .reservas-list::-webkit-scrollbar-thumb {
    background: #3a3a3a;
    border-radius: 3px;
  }

  .reserva-item {
    background: #1a1a1a;
    border: 1px solid #3a3a3a;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 12px;
    transition: all 0.3s ease;
  }

  .reserva-item:hover {
    border-color: #6b7280;
    background: #1f1f1f;
  }

  .reserva-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
  }

  .reserva-cliente {
    color: #ffffff;
    font-size: 16px;
    font-weight: 500;
  }

  .reserva-estado {
    font-size: 11px;
    padding: 4px 10px;
    border-radius: 12px;
    font-weight: 500;
    background: #1f4d2e;
    color: #7dd3a0;
  }

  .reserva-info {
    display: flex;
    gap: 16px;
    color: #9ca3af;
    font-size: 14px;
  }

  .reserva-fecha,
  .reserva-hora {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .icon {
    width: 16px;
    height: 16px;
  }

  .dias-list,
  .horas-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid #3a3a3a;
  }

  .dias-list :global(.chip) {
    background: #1a1a1a;
    border: 1px solid #3a3a3a;
    border-radius: 8px;
    padding: 8px 12px;
    color: #ffffff;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .dias-list :global(.chip-remove) {
    color: #9ca3af;
    cursor: pointer;
    font-size: 16px;
    line-height: 1;
    transition: color 0.3s ease;
  }

  .chip-remove:hover {
    color: #e58888;
  }

  .empty-state {
    text-align: center;
    padding: 40px;
    color: #6b7280;
  }

  .empty-state-icon {
    font-size: 48px;
    margin-bottom: 16px;
    opacity: 0.5;
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }

  .btn-group {
    display: flex;
    gap: 8px;
    margin-top: 8px;
  }

  .btn-small {
    padding: 8px 16px;
    font-size: 13px;
  }

  .stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
  }

  .stat-card {
    background: #1a1a1a;
    border: 1px solid #3a3a3a;
    border-radius: 8px;
    padding: 20px;
    text-align: center;
  }

  .stat-number {
    color: #ffffff;
    font-size: 32px;
    font-weight: 600;
    margin-bottom: 4px;
  }

  .stat-label {
    color: #9ca3af;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .main-panels {
    display: flex;
    flex-direction: column;
    gap: 32px;
  }

  @media (max-width: 768px) {
    .grid {
      grid-template-columns: 1fr;
    }

    .form-row {
      grid-template-columns: 1fr;
    }
  }
</style>

<!-- TODO: A√ëADIR POSIBILIDAD DE ACEPTAR REGISTRO DE UN USUARIO -->
