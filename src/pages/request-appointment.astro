---
import Layout from "../layouts/Layout.astro";
import { verifyToken } from "@/lib/auth";

const cookieHeader = Astro.request?.headers.get("cookie") || "";
const origin = new URL(Astro.request?.url || "http://localhost:4321").origin;

const token = Astro.cookies.get("auth_token")?.value;
let currentUserId = null;

if (token) {
  try {
    const payload = await verifyToken(token);
    currentUserId = payload?.userId;
  } catch (error) {
    console.error("Error al verificar token:", error);
  }
}

const appointmentsResponse = await fetch(`${origin}/api/appointments`, {
  headers: { cookie: cookieHeader },
});

const appointmentsData = await appointmentsResponse.json();
const appointments = appointmentsData?.appointments || [];

const appointmentsSplittedByDay = appointments.reduce(
  (acc: any, appointment: any) => {
    const date = new Date(appointment.appointmentDate);

    const day = date.getDate();
    const month = date.getMonth() + 1;
    const year = date.getFullYear();

    if (!acc[`${month}-${day}-${year}`]) {
      acc[`${month}-${day}-${year}`] = [];
    }

    acc[`${month}-${day}-${year}`].push({
      appointmentDate: appointment.appointmentDate,
      ...appointment,
    });
    return acc;
  },
  {},
);
---

<Layout title="Reservar Cita" description="Página para reservar una cita.">
  <div class="reserva-container">
    <div class="header">
      <h1>RESERVAR CITA</h1>
    </div>

    <section class="selector-dias">
      {
        Object.keys(appointmentsSplittedByDay).map((appointmentDate: any) => {
          const [month, day, year] = appointmentDate.split("-");
          const date = new Date(`${year}-${month}-${day}`);

          return (
            <article class="item-day" data-date={appointmentDate}>
              <div class="dia-nombre">
                {date
                  .toLocaleString("es-ES", { weekday: "short", timeZone: "Europe/Madrid" })
                  .toUpperCase()}
              </div>
              <div class="dia-numero">{date.getDate()}</div>
              <div class="dia-mes">
                {date
                  .toLocaleString("es-ES", { month: "short", timeZone: "Europe/Madrid" })
                  .toUpperCase()}
              </div>
              <div class="dia-anio">{date.getFullYear()}</div>
            </article>
          );
        })
      }
    </section>

    <section class="horarios-container">
      <p class="horarios-placeholder">
        Selecciona un día para ver las horas disponibles
      </p>
    </section>

    <button id="confirm-button" class="btn-confirmar" disabled
      >Confirmar Reserva</button
    >

    <p class="seleccion-info">Selecciona un día y una hora para poder continuar</p>

    <div class="volver">
      <a href="/">← Volver al inicio</a>
    </div>
  </div>
</Layout>

<script define:vars={{ appointmentsSplittedByDay, currentUserId }} is:inline>
  window.appointmentsSplittedByDay = appointmentsSplittedByDay;
  window.currentUserId = currentUserId;
</script>

<script>
  import { toast } from "@/lib/toast";

  const appointmentsSplittedByDay = (window as any).appointmentsSplittedByDay;
  const currentUserId = (window as any).currentUserId;

  let selectedDay: Element | null = null;
  let selectedHour: Element | null = null;
  let selectedAppointmentId: Date | null = null;

  const confirmButton = document.getElementById(
    "confirm-button",
  ) as HTMLButtonElement;
  const dayItems = document.querySelectorAll(".item-day");

  dayItems.forEach((item) => {
    item.addEventListener("click", () => {
      dayItems.forEach((i) => i.classList.remove("selected"));
      item.classList.add("selected");
      selectedDay = item;
      selectedAppointmentId = null;
      selectedHour = null;
      confirmButton.disabled = true;
      loadHoursForSelectedDay();
    });
  });

  confirmButton.addEventListener("click", async () => {
    if (selectedAppointmentId) {
      const response = await fetch(
        `/api/appointments/${selectedAppointmentId}`,
        {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
        },
      );

      const result = await response.json();

      if (result.success) {
        toast.success(result.message);

        if (selectedHour) {
          const estado = selectedHour.querySelector(".estado");

          selectedHour.classList.add("ocupada");

          if (!estado) return;

          estado.classList.remove("disponible");
          estado.classList.add("tu-reserva-badge");
          estado.textContent = "Tu reserva";
        }
        setTimeout(() => {
          window.location.reload();
        }, 1000);
      } else {
        toast.error(result.error);
      }
    }
  });

  function loadHoursForSelectedDay() {
    if (!selectedDay) return;

    const horariosContainer = document.querySelector(
      ".horarios-container",
    ) as HTMLElement;
    horariosContainer.innerHTML = "";

    const dateKey = selectedDay.getAttribute("data-date");
    if (!dateKey) return;

    const appointmentsForDay = appointmentsSplittedByDay[dateKey] || [];

    if (appointmentsForDay.length === 0) {
      horariosContainer.innerHTML = `
        <p class="horarios-placeholder">
          No hay horas disponibles para este día.
        </p>
      `;
      return;
    }

    appointmentsForDay.forEach((appointment: any) => {
      const date = new Date(appointment.appointmentDate);

      const horaItem = document.createElement("div");
      horaItem.classList.add("hora-item");

      const isOwnAppointment = appointment.userId === currentUserId;
      const isOccupied = appointment.userId && !isOwnAppointment;

      if (appointment.userId) horaItem.classList.add("ocupada");
      if (isOwnAppointment) horaItem.classList.add("tu-reserva");

      let estadoClass = "disponible";
      let estadoText = "Disponible";

      if (isOwnAppointment) {
        estadoClass = "tu-reserva-badge";
        estadoText = "Tu reserva";
      } else if (isOccupied) {
        estadoClass = "ocupada-badge";
        estadoText = "Ocupada";
      }

      horaItem.innerHTML = `
        <span class="hora-texto">${date.toLocaleString("es-ES", {
          hour: "2-digit",
          minute: "2-digit",
          hour12: false,
          timeZone: "Europe/Madrid",
        })}</span>
        <span class="estado ${estadoClass}">
          ${estadoText}
        </span>
      `;

      if (!appointment.userId) {
        horaItem.addEventListener("click", () => {
          document
            .querySelectorAll(".hora-item")
            .forEach((i) => i.classList.remove("selected"));
          horaItem.classList.add("selected");
          selectedAppointmentId = appointment.id;
          selectedHour = horaItem;
          confirmButton.disabled = false;
        });
      }

      horariosContainer.appendChild(horaItem);
    });
  }
</script>

<style>
  body {
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .reserva-container {
    background: #232323;
    border-radius: 16px;
    padding: 48px 40px;
    width: 100%;
    max-width: 420px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
  }

  .header {
    text-align: center;
    margin-bottom: 32px;
  }

  .header h1 {
    color: #ffffff;
    font-size: 28px;
    font-weight: 300;
    letter-spacing: 2px;
    margin-bottom: 24px;
  }

  .selector-dias {
    display: flex;
    gap: 8px;
    overflow-x: auto;
    padding: 4px 0;
    margin-bottom: 24px;
  }

  .selector-dias::-webkit-scrollbar {
    height: 4px;
  }

  .selector-dias::-webkit-scrollbar-track {
    background: #1a1a1a;
    border-radius: 2px;
  }

  .selector-dias::-webkit-scrollbar-thumb {
    background: #3a3a3a;
    border-radius: 2px;
  }

  .item-day {
    min-width: 70px;
    background: #1a1a1a;
    border: 1px solid #3a3a3a;
    border-radius: 8px;
    padding: 12px 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
    flex-shrink: 0;
  }

  .item-day:hover {
    background: #1f1f1f;
    border-color: #6b7280;
  }

  .item-day.selected {
    background: #2d3748;
    border-color: #6b7280;
    transform: translateY(-2px);
  }

  .dia-nombre {
    color: #9ca3af;
    font-size: 11px;
    font-weight: 500;
    text-transform: uppercase;
    margin-bottom: 4px;
  }

  .item-day.selected .dia-nombre {
    color: #ffffff;
  }

  .dia-numero {
    color: #ffffff;
    font-size: 18px;
    font-weight: 600;
  }

  .dia-mes {
    color: #6b7280;
    font-size: 10px;
    text-transform: uppercase;
    margin-top: 2px;
  }

  .dia-anio {
    color: #6b7280;
    font-size: 10px;
    text-transform: uppercase;
    margin-top: 2px;
  }

  .item-day.selected .dia-mes {
    color: #9ca3af;
  }

  .horarios-container {
    max-height: 400px;
    overflow-y: auto;
    padding-right: 4px;
  }

  .horarios-container::-webkit-scrollbar {
    width: 6px;
  }

  .horarios-container::-webkit-scrollbar-track {
    background: #1a1a1a;
    border-radius: 3px;
  }

  .horarios-container::-webkit-scrollbar-thumb {
    background: #3a3a3a;
    border-radius: 3px;
  }

  .horarios-container::-webkit-scrollbar-thumb:hover {
    background: #4a4a4a;
  }

  .horarios-container :global(.hora-item) {
    background: #1a1a1a;
    border: 1px solid #3a3a3a;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .horarios-container
    :global(.hora-item:hover:not(.tu-reserva, .ocupada, .selected)) {
    background: #1f1f1f;
    border-color: #6b7280;
    transform: translateX(4px);
  }

  .horarios-container :global(.hora-item.selected) {
    background: #2d3748;
    border-color: #6b7280;
    transform: translateX(4px);
  }

  .horarios-container :global(.hora-texto) {
    color: #ffffff;
    font-size: 18px;
    font-weight: 500;
  }

  .horarios-container :global(.hora-item.ocupada) {
    opacity: 0.4;
    cursor: not-allowed;
    background: #1a1a1a;
    border-color: #4a2929;
  }

  .horarios-container :global(.hora-item.tu-reserva) {
    opacity: 1;
    background: #1a1e25;
    border-color: #1e2d46;
  }

  .horarios-container :global(.hora-item.ocupada .hora-texto) {
    text-decoration: line-through;
  }

  .horarios-container :global(.estado) {
    font-size: 12px;
    padding: 4px 12px;
    border-radius: 12px;
    font-weight: 500;
  }

  .horarios-container :global(.disponible) {
    background: #1f4d2e;
    color: #7dd3a0;
  }

  .horarios-container :global(.ocupada-badge) {
    background: #4a2929;
    color: #e58888;
  }

  .horarios-container :global(.tu-reserva-badge) {
    background: #1e2d46;
    color: #93c5fd;
  }

  .horarios-container :global(.horarios-placeholder) {
    text-align: center;
    color: #6b7280;
    font-size: 14px;
    padding: 40px 20px;
  }

  .btn-confirmar {
    width: 100%;
    padding: 14px;
    background: #3a3a3a;
    color: #ffffff;
    border: none;
    border-radius: 8px;
    font-size: 15px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-top: 24px;
  }

  .btn-confirmar:hover {
    background: #4a4a4a;
    transform: translateY(-1px);
  }

  .btn-confirmar:active {
    transform: translateY(0);
  }

  .btn-confirmar:disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }

  .btn-confirmar:disabled:hover {
    transform: none;
    background: #3a3a3a;
  }

  .seleccion-info {
    text-align: center;
    color: #9ca3af;
    font-size: 14px;
    margin-top: 16px;
  }

  .volver {
    text-align: center;
    margin-top: 24px;
  }

  .volver a {
    color: #9ca3af;
    text-decoration: none;
    font-size: 14px;
    transition: color 0.3s ease;
  }

  .volver a:hover {
    color: #ffffff;
  }
</style>
